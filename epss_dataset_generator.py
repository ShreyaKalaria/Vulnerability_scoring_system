# -*- coding: utf-8 -*-
"""
Created on Sat Aug 13 05:13:54 2022

@author: Arman Hossain
"""

# ! pip install pyexploitdb

import pandas as pd

from df_utilities import add_columns_to_df
from pyExploitDb import PyExploitDb
from utilities import read_csv_dataset

class P_ven_prod():
    def __init__(self,cpe_series):
        self.cpe_series = cpe_series
        self.vendors = []
        self.prods = []
        self.vendor_df = pd.DataFrame()
        self.prod_df = pd.DataFrame()
        self.vendor_info = {}
        
    def perse(self,top_vendors,top_prods):
        '''
        this will add columns vendors from top_vendors and prods from top_prds with respect to all cve ids.
        example:
            id microsoft chrome
            1     5        6
            2     0        0 [because cve-2 is do not affect microsoft or chorme]

        '''
        
        lst = self.cpe_series.values.tolist()
        # vendor_lst1 = ['microsoft','adobe','ibm','hp','apache','apple','linux','oracle','opensuse','cisco','huawei','canonical','redhat','debian']
        # vendor_lst = ['microsoft','adobe','ibm','hp','apache','apple','google']
        df = pd.DataFrame()
        # for vendor in vendor_lst:
        #     df[vendor] = [0]*len(cpe_series)
        
        index = 0
        for item in lst:
            if(not isinstance(item, str)):
                index+=1
                continue
            cpe_lst = item.split('#arman#')
            
            for a_cpe in cpe_lst:
                a_cpe_sp = a_cpe.split(':')
                vendor= a_cpe_sp[3]
                prod = vendor+"_"+a_cpe_sp[4]
                if vendor not in self.vendors:
                    self.vendors.append(vendor)
                    if vendor in top_vendors.index:
                        self.vendor_df[vendor] = [0]*len(self.cpe_series)
                if vendor in top_vendors.index:
                    self.vendor_df[vendor][index] = top_vendors['count'][vendor]
                
                # if prod not in self.prods:
                #     self.prods.append(prod)
                #     if prod in top_prods.index:
                #         self.prod_df[prod] = [0]*len(self.cpe_series)
                # if prod in top_prods.index:
                #     self.prod_df[prod][index] = top_prods['count'][prod]
                
                
            index+=1
    def gen_vendor_info(self):
        
        '''
        will provide all the vendors and count in dataset cpe2uri
        microsoft 34234
        juniper 234
        ...
        '''
        
        lst = self.cpe_series.values.tolist()
        index = 0
        for item in lst:
            if(not isinstance(item, str)):
                index+=1
                continue
            cpe_lst = item.split('#arman#')
            for a_cpe in cpe_lst:
                a_cpe_sp = a_cpe.split(':')
                vendor= a_cpe_sp[3]
                
                if vendor not in self.vendor_info.keys():
                    self.vendor_info[vendor] = 0
                self.vendor_info[vendor] += 1
                
            index+=1
            
        return pd.DataFrame.from_dict(self.vendor_info, orient='index') 
    
    
    
    # def gen_vendor_info2(self):
    #     lst = self.cpe_series.values.tolist()
    #     index = 0
    #     for item in lst:
    #         if(not isinstance(item, str)):
    #             index+=1
    #             continue
    #         cpe_lst = item.split('#arman#')
    #         temp_list = []
    #         for a_cpe in cpe_lst:
    #             a_cpe_sp = a_cpe.split(':')
    #             vendor= a_cpe_sp[3]
                
    #             if vendor not in self.vendor_info.keys():
    #                 self.vendor_info[vendor] = 0
    #             if(vendor):
    #             self.vendor_info[vendor] += 1
                
    #         index+=1
            
    #     return pd.DataFrame.from_dict(self.vendor_info, orient='index')
    



    

def count_ref(ref_source):
    
    lst = ref_source.values.tolist()
    df = pd.DataFrame()
    df['ref_count'] = [0]*len(ref_source)
    
    index = 0
    for item in lst:
        if(not isinstance(item, str)): # if None
            index+=1
            continue
        refcnt = len(item.split('#arman#'))
        
        df['ref_count'][index] = refcnt
        index+=1
    
    return df
    

# def exploit():
#     expltlst = ['poc_code','weaponized']
#     return 0


def tags_poc_from_exploit_db(cve_id_series):
    
    # taglst = ['remote','dos','webapps','local'] # 'code_execution','memory_corruption' not in exploitdb
    taglst = [] # 'code_execution','memory_corruption' not in exploitdb
    pEdb = PyExploitDb()
    pEdb.debug = False
    pEdb.openFile()
    
    df = pd.DataFrame()
    # for tag in taglst:
    #     df[tag] = [0]*len(cve_id_series)
        
    # df['poc_code'] = [0]*len(cve_id_series) 
    df['code_link'] = [None]*len(cve_id_series) 
    
    index = 0
    for id in cve_id_series:    
        results = pEdb.searchCve(id)
        # results = pEdb.searchCve('CVE-2018-14592')
        # results = pEdb.searchCve('CVE-2021-1167')
        if (results==[] or type(results) != dict):
            index+=1
            continue
        else:
            # df['poc_code'][index] = 1
            df['code_link'][index] = results['exploit']
            # if("tag_"+results['platform'] not in taglst):
            #     taglst.append("tag_"+results['platform'])
            #     df["tag_"+results['platform']] = [0]*len(cve_id_series)
            # df["tag_"+results['platform']][index] = 1
                
            
        index+=1
        
        
    return df
        


def get_epss(data):
    data["epss"] = [0]*len(data)
    epss = pd.read_csv('D:/arman/scripts/data/output/downloaded/epss_scores-2022-08-13.csv',index_col=0)
    for id in epss.index:
        if id in data.index:
            score = epss['#model_version:v2022.01.01'][id]
            data['epss'][id] = score
    return data

def generate(data,top_vend,top_prod):
    
    total_df = pd.DataFrame()
    total_df['ID'] = data['ID']
    

    vendor_product_perser = P_ven_prod(data['cpe23Uri'])
    vendor_product_perser.perse(top_vend,top_prod)
    total_df = add_columns_to_df(total_df, vendor_product_perser.vendor_df)
    
    ref_cnt_df = count_ref(data['refsource'])
    total_df = add_columns_to_df(total_df, ref_cnt_df)
    
    tag_poc_df = tags_poc_from_exploit_db(data['ID'])
    total_df = add_columns_to_df(total_df, tag_poc_df)
    # total_df = add_columns_to_df(total_df, vendor_product_perser.prod_df)
    total_df.index = total_df["ID"]
    total_df = get_epss(total_df)
    # total_df.to_csv("166_22_desc_filtered_data.csv",index=False)
    return total_df

def generate_for_ui(data):
    
    total_df = pd.DataFrame()
    total_df['ID'] = data['ID']
    
    total_df = add_columns_to_df(total_df, data['description'],'description')
    total_df = add_columns_to_df(total_df, data['url'],'url')
    
    
    
    ref_cnt_df = count_ref(data['refsource'])
    total_df = add_columns_to_df(total_df, ref_cnt_df)
    
    total_df = add_columns_to_df(total_df, data['tags'],'tags')
    total_df = add_columns_to_df(total_df, data['cpe23Uri'],'cpeUri')
    total_df = add_columns_to_df(total_df, data['vectorString'],'vectorString_v31')
    total_df = add_columns_to_df(total_df, data['vectorString_v2'],"vectorString_v2")
    total_df = add_columns_to_df(total_df, data['baseScore'],'CVSS_v31')
    total_df = add_columns_to_df(total_df, data['baseScore_v2'],'CVSS_v2')
    total_df = add_columns_to_df(total_df, data['epss'],'epss')
    
    # data['CVSS31'] = mdata['baseScore']
    # data['CVSS2'] = mdata['baseScore_v2']
    
    tag_poc_df = tags_poc_from_exploit_db(data['ID'])
    total_df = add_columns_to_df(total_df, tag_poc_df)
    # total_df = add_columns_to_df(total_df, vendor_product_perser.prod_df)
    total_df.index = total_df["ID"]
    total_df = get_epss(total_df)
    
    return total_df

def dataforexcel():
    mdata = read_csv_dataset('./data/2002_22_nvd.csv')
    excel_data = generate_for_ui(mdata)    
    excel_data.to_csv('./data/data_for_excel.csv',index = False)


#%% main
if __name__ == "__main__":
    # for EPSS model generation data
    
    top_vend = pd.read_csv('../data2/top_vendors.csv',index_col=0)
    top_prod = pd.read_csv('../data2/top_products.csv',index_col=0)
    
    mdata = read_csv_dataset('./data/2002_22_nvd.csv')
    
    data = generate(mdata,top_vend,top_prod)
    arr = ['attackVector','attackComplexity','privilegesRequired','userInteraction','scope',
           'confidentialityImpact','integrityImpact','availabilityImpact']
    
    for i in arr:
        codes, uniques = pd.factorize(mdata[i])
        data[i] = codes
    dat = mdata['baseScore']
    data['cvss'] = list(dat.round())
    
    
    
    dat = data['epss'].astype(float)
    data['epss'] = list(dat.round(decimals=2))
    
    mdata['baseScore'].round()
    type(data['epss']['CVE-2019-0001'])
    data['epss'].astype(float)
    data['epss'].round(decimals=1)
    
    # droping
    data2 = data[data.attackVector != -1]
    data2 = data2[data2.attackComplexity != -1]
    data2 = data2[data2.privilegesRequired != -1]
    data2 = data2[data2.userInteraction != -1]
    data2 = data2[data2.scope != -1]
    data2 = data2[data2.confidentialityImpact != -1]
    data2 = data2[data2.integrityImpact != -1]
    data2 = data2[data2.availabilityImpact != -1]
    for id in data2.index:
        val = data2['epss'][id]*100
        if val <= 1:
            data2['epss'][id] = 1
        elif val <= 10:
            data2['epss'][id] = 2
        else:
            data2['epss'][id] = 3
            
# saving data

    import pickle
    with open('all_data.pickle', 'wb') as f:
        pickle.dump(data, f)
    
    total_df.to_csv('all_vend_ref_epss2.csv',index = False)
    data2.to_csv('latest2.csv',index = False)
    
    
    data.to_csv("16_22_desc_filtered_data.csv",index=False)
    
    vendor_product_perser = P_ven_prod(data['cpe23Uri'])
    
    vendor_product_perser.gen_vendor_info()
    
    vendor_inf = vendor_product_perser.vendor_info
    
    
    df = pd.DataFrame.from_dict(vendor_inf, orient='index') 
    df.to_csv('vendor.csv')

































