# -*- coding: utf-8 -*-
"""
Created on Fri Aug 19 15:31:01 2022

@author: Arman
"""

import pandas as pd

def perse_cpe(datafm): # assumin cveId as index
    vendors = {}
    for id in datafm.index:
        # print(id)
        # print(datafm[id])
        if(not isinstance(datafm[id],str)):
            continue
        cpe_lst = datafm[id].split('#arman#')
        tempVendors = {}
        for a_cpe in cpe_lst:
            a_cpe_sp = a_cpe.split(':')
            tvendor = a_cpe_sp[3]
            product = a_cpe_sp[4]
            version = a_cpe_sp[5]
            if tvendor not in tempVendors.keys():
                tempVendors[tvendor] = {"ID":id}
            if product not in tempVendors[tvendor].keys():
                tempVendors[tvendor][product] = [version]
            elif version not in tempVendors[tvendor][product]:
                tempVendors[tvendor][product].append(version)
        # print(tempVendors)
        for prod in tempVendors.keys():
            if prod not in vendors.keys():
                vendors[prod] = pd.DataFrame()
            
            for key in tempVendors[prod]:
                if key!="ID":
                    # print(prod)
                    # tempVendors[prod][key+"_len"] = len(tempVendors[prod][key])
                    tempVendors[prod][key] = ",".join(tempVendors[prod][key])
            vendors[prod] = vendors[prod].append(tempVendors[prod],ignore_index = True)
    return vendors

#%% calling
data = pd.read_csv('../data/all_data_2019.csv',index_col="ID")
vendors = perse_cpe(data["cpe23Uri"])


#

#%% saving as pickle

import pickle
with open('dict_of_dfs.pickle', 'wb') as f:
    pickle.dump(vendors, f)
    
# %% reading data

vedors_pickle = {}
with open('dict_of_dfs.pickle', 'rb') as f:
    vedors_pickle = pickle.load(f)