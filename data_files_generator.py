# -*- coding: utf-8 -*-
"""
Created on Thu Oct 27 16:36:32 2022

@author: arman hossain
"""
from utilities import vendor_name, date_yy_mm, read_csv_dataset, min_max_year
import pickle

def save_pickle(obj,file_name):
    with open("data/"+file_name , 'wb') as file:
        pickle.dump(obj, file)

def vendor_vs_count(cpe_series,dates):
    
    '''
    will provide all the vendors and count with respect to year
    
    {
        microsoft:
            {
                1999: count,
                1999.5: count,
            }
        juniper:
            {
                1999: count,
                1999.5: count,
            }
    }
    
    '''
    vendor_info = {}
    lst = cpe_series.values.tolist()
    dates = dates.values.tolist()
    mini,maxi = min_max_year(dates)
    
    index = 0
    for item in lst:
        if(not isinstance(item, str)):
            index+=1
            continue
        cpe_lst = item.split('#arman#')
        for a_cpe in cpe_lst:
            vendor = vendor_name(a_cpe)
            
            # initializing new vendor object
            if vendor not in vendor_info.keys():
                vendor_info[vendor] = {}
                c = mini+0.0
                while(c<maxi+1):
                    vendor_info[vendor][c] = 0
                    c = c+0.5
            # updating vendor object
            # print(index,"---------------------------")
            yy_mm = date_yy_mm(dates[index])
            yy = yy_mm[0]
            if yy_mm[1] > 6: yy += 0.5
            else: yy+=0.0
            vendor_info[vendor][yy] +=1
            # if vendor== "5none": print(vendor,yy,vendor_info[vendor][yy])
            
        index+=1
    save_pickle(vendor_info,'2002-2022-vendor-year-count.pickle')
    # return pd.DataFrame.from_dict(vendor_info, orient='index')
    return vendor_info

def year_vs_cnt(dates):
    '''
    will provide vulnerability counts with respect to year
    
    {
        1999.0: count,
        1999.5: count,
        2000.0: count,
        2000.5: count,
    }
    '''
    vendor_info = {}
    dates = dates.values.tolist()
    mini,maxi = min_max_year(dates)
    
    c = mini+0.0
    while(c<maxi+1):
        vendor_info[c] = 0
        c = c+0.5
    for i in range(len(dates)):
        yy_mm = date_yy_mm(dates[i])
        yy = yy_mm[0]
        if yy_mm[1] > 6: yy += 0.5
        else: yy+=0.0
        vendor_info[yy] +=1
    save_pickle(vendor_info, "year_vs_cnt.pickle")
    return vendor_info
    
def generate(data):
    data = read_csv_dataset("data/2002_22_nvd.csv")
    vendor_cnt = vendor_vs_count(data['cpe23Uri'], data["publishedDate"])
    vendor_cnt = year_vs_cnt(data["publishedDate"])

