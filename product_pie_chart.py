# -*- coding: utf-8 -*-
"""
Created on Sun Oct 30 22:02:28 2022

@author: arman hossain
!python product_pie_chart.py
"""

from PyQt5.QtWidgets import QApplication, QWidget, QVBoxLayout
import sys
from PyQt5.QtChart import QChart, QChartView, QPieSeries, QPieSlice
from PyQt5.QtGui import QPainter, QPen
from PyQt5.QtCore import Qt
import pickle 


class Window(QWidget):
    def __init__(self, parent=None):
        super().__init__(parent)
 
        self.setWindowTitle("PyQtChart Pie Chart")
        self.setGeometry(100,100, 1280,600)
        self.read_data("./data/2002-2022-vendor_product_vs_count.pickle")
        vbox = QVBoxLayout()
        vbox.setContentsMargins(0,0,0,0)
        
        self.setLayout(vbox)
        self.show()
        # self.read_data("../data/2002-2022-vendor-year-count.pickle")
        # self.create_piechart()
        
    def read_data(self,filename):
        with open(filename, 'rb') as file:
            obj = pickle.load(file)
        self.data = obj
        
    
    def total_veulnerability_by_year(self,dict_):
        ''' 
        intended for this dictionary
        
        {
            1999: count,
            1999.5: count,

        }
        
        '''
        total = 0
        for key in dict_:
            total+=dict_[key]
        return total


    def total_veulnerability(self,dict_):
        '''
        intended for this dictionary
        
        {
            microsoft:
                {
                     prod1:
                         {
                             1999: count,
                             1999.5: count,
                         },
                         prod2:
                             {
                                 1999: count,
                                 1999.5: count,
                             },
                             
                         
                }
            juniper:
                {
                    1999: count,
                    1999.5: count,
                }
        }
        
        '''
        total = 0
        for key in dict_:
            for item in dict_[key]:
                total+=dict_[key][item]
        return total
    
    def clearLayout(self,layout):
        if layout==None: return
        
        while layout.count():
            child = layout.takeAt(0)
            if child.widget():
                child.widget().deleteLater()
                
    def create_piechart(self,product_name,maxi):
        data_dict = self.data[product_name]
        cnt = 0
        total_individual = 0
        series = QPieSeries()
        total = self.total_veulnerability(data_dict)
        keys =  list(data_dict.keys())
        while total_individual < total/2:
            key = keys[cnt]
            if cnt > maxi: break
            individual = self.total_veulnerability_by_year(data_dict[key])
            series.append(key+" "+str(round(individual/total*100,2))+"%", individual)
            total_individual+=individual
            cnt+=1
        # for key in data_dict:
        #     if cnt == first_n: break
        #     cnt+=1
        #     individual = self.total_veulnerability_by_year(data_dict[key])
        #     series.append(key, individual)
        #     total_individual+=individual
        series.append(str(len(data_dict.keys())-cnt+1)+" others "+str(round((total-total_individual)/total*100,2))+"%", total-total_individual)
        
        for i in range(cnt+1):
            #adding slice
            slice = QPieSlice()
            slice = series.slices()[i]
            # slice.setExploded(True)
            slice.setLabelVisible(True)
            # slice.setPen(QPen(Qt.darkGreen, 2))
            # slice.setBrush(Qt.green)
 
 
 
 
        chart = QChart()
        chart.legend().hide()
        chart.addSeries(series)
        chart.createDefaultAxes()
        chart.setAnimationOptions(QChart.SeriesAnimations)
        chart.setTitle("Pie Chart Example")
 
        chart.legend().setVisible(True)
        chart.legend().setAlignment(Qt.AlignBottom)
 
        chartview = QChartView(chart)
        chartview.setRenderHint(QPainter.Antialiasing)
 
        
        self.clearLayout(self.layout())
        self.layout().addWidget(chartview)
 

if __name__ == "__main__":
    # top vendors ['qualcomm', 'cisco', 'microsoft', 'apple', 'linux', 'intel', 'mozilla', 'adobe', 'oracle', 'ibm', 'google', 'sun', 'juniper', 'f5', 'hp', 'redhat', 'huawei', 'opera', 'apache', 'netgear', 'php', 'debian', 'vmware', 'siemens', 'canonical', 'dell', 'lenovo', 'zohocorp', 'netapp', 'amd', 'moodle']
    # for qualcom ['mdm9607', 'mdm9206', 'mdm9607_firmware']
    App = QApplication(sys.argv)
    window = Window()
    window.create_piechart('cisco',10)
    sys.exit(App.exec_())
    
    