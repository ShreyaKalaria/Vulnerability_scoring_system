# -*- coding: utf-8 -*-
"""
Created on Sun Oct 30 22:02:00 2022


@author: arman hossain

!python veondor_pie_chart.py
"""

from PyQt5.QtWidgets import QApplication, QMainWindow
import sys
from PyQt5.QtChart import QChart, QChartView, QPieSeries, QPieSlice
from PyQt5.QtGui import QPainter, QPen
from PyQt5.QtCore import Qt
import pickle 
 

 
class Window(QMainWindow):
    def __init__(self):
        super().__init__()
        self.title = "Vendor affected"
        self.setWindowTitle(self.title)
        # self.setGeometry(100,100, 1280,600)
        data = self.read_pickle('../data/2002-2022-vendor-year-count.pickle')
        self.create_piechart(data)
        self.show()

    
    def read_pickle(self,filename):
        with open(filename, 'rb') as file:
            obj = pickle.load(file)
        # filename = "2002-2022-vendor-year-count.pickle"
        return obj
    
    def total_veulnerability_by_year(self,dict_):
        ''' 
        intended for this dictionary
        
        {
            1999: count,
            1999.5: count,

        }
        
        '''
        total = 0
        for key in dict_:
            total+=dict_[key]
        return total


    def total_veulnerability(self,dict_):
        '''
        intended for this dictionary
        
        {
            microsoft:
                {
                    1999: count,
                    1999.5: count,
                }
            juniper:
                {
                    1999: count,
                    1999.5: count,
                }
        }
        
        '''
        total = 0
        for key in dict_:
            for item in dict_[key]:
                total+=dict_[key][item]
        return total
    
    def create_piechart(self,data_dict):
        cnt = 0
        total_individual = 0
        series = QPieSeries()
        total = self.total_veulnerability(data_dict)
        keys =  list(data_dict.keys())
        while total_individual < total/2:
            key = keys[cnt]
            # if cnt > 15: break
            individual = self.total_veulnerability_by_year(data_dict[key])
            series.append(key+" "+str(round(individual/total*100,2))+"%", individual)
            total_individual+=individual
            cnt+=1
        # for key in data_dict:
        #     if cnt == first_n: break
        #     cnt+=1
        #     individual = self.total_veulnerability_by_year(data_dict[key])
        #     series.append(key, individual)
        #     total_individual+=individual
        series.append(str(len(data_dict.keys())-cnt+1)+" others "+str(round((total-total_individual)/total*100,2))+"%", total-total_individual)
        
        for i in range(cnt+1):
            #adding slice
            slice = QPieSlice()
            slice = series.slices()[i]
            # slice.setExploded(True)
            slice.setLabelVisible(True)
            # slice.setPen(QPen(Qt.darkGreen, 2))
            # slice.setBrush(Qt.green)
 
 
 
 
        chart = QChart()
        chart.legend().hide()
        chart.addSeries(series)
        chart.createDefaultAxes()
        chart.setAnimationOptions(QChart.SeriesAnimations)
        chart.setTitle(self.title)
 
        chart.legend().setVisible(True)
        chart.legend().setAlignment(Qt.AlignBottom)
 
        chartview = QChartView(chart)
        chartview.setRenderHint(QPainter.Antialiasing)
 
        self.setCentralWidget(chartview)
 

if __name__ == "__main__":
    
    
    App = QApplication(sys.argv)
    window = Window()
    # window.create_piechart(data)
    sys.exit(App.exec_())
    
    
